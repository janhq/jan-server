# API Conventions

## Errors

All error responses follow the structure:

```json
{
  "type": "invalid_request_error|auth_error|rate_limit_error|internal_error",
  "code": "string",
  "message": "human-friendly message",
  "param": "optional field name",
  "request_id": "uuid"
}
```

`request_id` is propagated from `X-Request-Id` or generated by the API and should be included in support conversations.

## Idempotency

`POST` endpoints that trigger work (`/v1/chat/completions`, `/v1/responses`, `/v1/conversations/*/runs`) accept an `Idempotency-Key` header. The key is combined with the principal identifier, method, and route. Subsequent calls with the same tuple will return the cached response (including SSE payloads) instead of re-executing the underlying request.

## Pagination

Collection endpoints use cursor-based pagination with `limit` and `after` query parameters. Responses include:

```json
{
  "data": [ ... ],
  "next_after": "cursor-or-null"
}
```

Providing `after` with the value of `next_after` from the previous response yields the next page (or terminates when `null`).

## Authentication

All public routes are served at `/v1/*` through Kong. Two modes of authentication are accepted on the same routes:

- **API Keys** via `X-API-Key` (validated at Kong). Kong injects `X-Consumer-*` headers that the API uses to build a principal. Responses include `X-Principal-Id` and `X-Auth-Method: api_key`.
- **JWT Bearer tokens** issued by Keycloak. Tokens are validated inside `llm-api` using the configured JWKS endpoint. Valid responses include `X-Auth-Method: jwt`.

Clients can rely on these headers when invoking downstream services.

## Streaming (SSE)

Passing `stream=true` to supported endpoints switches the response to `text/event-stream`. Each chunk is JSON encoded and prefixed with `data:` per SSE conventions, concluding with `data: [DONE]`. Idempotent replays flush the recorded stream for the same key.

## Request Metadata

`llm-api` propagates the following headers downstream:

- `X-Principal-Id`
- `X-Auth-Method`
- `X-Scopes` (space-separated)
- `X-Request-Id`

Downstream providers can use these for auditing or logging without coupling to the original authentication mechanism.
